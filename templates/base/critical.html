{% load static %}
<style>
    /* 1. Базовые правила: резервируем блочную модель, но скрываем контент */
    [data-translate] {
        visibility: hidden;
        opacity: 0;
        display: inline-block;
        text-align: center;
        box-sizing: content-box;
        padding: 0 2px;
        transition: opacity 0.2s ease-in;
    }

    /* 2. Показываем только тогда, когда основной скрипт закончит перевод */
    .translated [data-translate] {
        visibility: visible;
        opacity: 1;
    }

    /* 3. Универсальные классы (уже знакомые тебе) */
    /* CSS классы для ширины от 1 до 9 символов */
    .ch-1 { min-width: 1ch; }
    .ch-2 { min-width: 2ch; }
    .ch-3 { min-width: 3ch; }
    .ch-4 { min-width: 4ch; }
    .ch-5 { min-width: 5ch; }
    .ch-6 { min-width: 6ch; }
    .ch-7 { min-width: 7ch; }
    .ch-8 { min-width: 8ch; }
    .ch-9 { min-width: 9ch; }
    /* CSS классы для ширины от 10 до 25 символов */
    .ch-10 { min-width: 10ch; }
    .ch-11 { min-width: 11ch; }
    .ch-12 { min-width: 12ch; }
    .ch-13 { min-width: 13ch; }
    .ch-14 { min-width: 14ch; }
    .ch-15 { min-width: 15ch; }
    .ch-16 { min-width: 16ch; }
    .ch-17 { min-width: 17ch; }
    .ch-18 { min-width: 18ch; }
    .ch-19 { min-width: 19ch; }
    .ch-20 { min-width: 20ch; }
    .ch-21 { min-width: 21ch; }
    .ch-22 { min-width: 22ch; }
    .ch-23 { min-width: 23ch; }
    .ch-24 { min-width: 24ch; }
    .ch-25 { min-width: 25ch; }
</style>

<script>
    (function() {
        // 1. Быстрая загрузка настроек
        const lang = localStorage.getItem('lang') || 'uz';
        const cacheRaw = localStorage.getItem('lang_cache');
        if (!cacheRaw) return;

        let widths = null;
        try {
            const cache = JSON.parse(cacheRaw);
            // ПРОВЕРКА: учитываем структуру твоего кэша { "uz": { "widths": {...} } }
            widths = cache[lang] && cache[lang].widths ? cache[lang].widths : null;
        } catch (e) { return; }

        if (!widths) return;

        // 2. Мгновенная инъекция стилей для конкретных ключей (чтобы LCP был 0)
        const style = document.createElement('style');
        let cssInject = '';
        for (const key in widths) {
            cssInject += `[data-translate="${key}"] { min-width: ${widths[key]}ch; }\n`;
        }
        style.textContent = cssInject;
        document.head.appendChild(style);

        // 3. MutationObserver для подстраховки (навешивает классы ch-X сразу при появлении в DOM)
        const observer = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
                for (const node of mutation.addedNodes) {
                    if (node.nodeType === 1) {
                        const targets = node.hasAttribute('data-translate') ? [node] : node.querySelectorAll('[data-translate]');
                        targets.forEach(el => {
                            const key = el.getAttribute('data-translate');
                            if (widths[key]) {
                                el.classList.add('ch-' + widths[key]);
                            }
                        });
                    }
                }
            }
        });

        observer.observe(document.documentElement, { childList: true, subtree: true });
        // Отключаем через время, когда основной JS подхватит
        window.addEventListener('load', () => setTimeout(() => observer.disconnect(), 2000));
    })();
</script>

<script priority="high" type="module" src="{% static 'js/language/translate.js' %}"></script>
<script>
    (function() {
      try {
        const saved = localStorage.getItem('theme');
        const mql = window.matchMedia('(prefers-color-scheme: dark)');
        const sysTheme = mql.matches ? 'dark' : 'light';
        if (saved === 'dark' || saved === 'light') {
          document.documentElement.setAttribute('data-theme', saved);
        } else {
          document.documentElement.setAttribute('data-theme', sysTheme);
        }
      } catch (e) {}
    })();
</script>
